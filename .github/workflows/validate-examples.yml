name: Validate Examples

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "docs/**"
  pull_request:
    paths-ignore:
      - "**.md"
      - "docs/**"

env:
  # When getting Rust dependencies, retry on network error:
  CARGO_NET_RETRY: 10
  # Use the local .curlrc
  CURL_HOME: .

jobs:
  validate-examples:
    name: Validate Examples on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Setup image (Linux)
        if: ${{ contains(matrix.os, 'ubuntu') }}
        run: ./.github/scripts/provision-linux-build.sh

      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.rustup/
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ matrix.os }}-cargo-${{ hashFiles('rust-toolchain.toml') }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build icp CLI
        run: cargo build

      - name: Validate examples
        run: ./scripts/validate-examples.sh

  aggregate:
    name: validate-examples:required
    if: ${{ always() }}
    runs-on: ubuntu-latest
    needs: [validate-examples]
    steps:
      - name: check result
        if: ${{ needs.validate-examples.result != 'success' }}
        run: exit 1
